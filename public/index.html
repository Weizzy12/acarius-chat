<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–∏–≤–∞—Ç–Ω—ã–π –ß–∞—Ç - –í—Ö–æ–¥</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="login-box" id="step1">
            <h1>üîí –ü—Ä–∏–≤–∞—Ç–Ω—ã–π –ß–∞—Ç</h1>
            <p>–î–ª—è –≤—Ö–æ–¥–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∏–Ω–≤–∞–π—Ç-–∫–æ–¥</p>
            
            <div class="form-group">
                <input type="text" id="inviteCode" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–Ω–≤–∞–π—Ç-–∫–æ–¥" class="form-input">
                <button onclick="checkCode()" class="btn btn-primary">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥</button>
            </div>
            
            <div id="error" class="error-message"></div>
        </div>
        
        <div class="login-box" id="step2" style="display: none;">
            <h1>üìù –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è</h1>
            <p>–ö–æ–¥ –ø—Ä–∏–Ω—è—Ç! –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ:</p>
            
            <div class="form-group">
                <input type="text" id="nickname" placeholder="–ò–º—è –≤ —á–∞—Ç–µ" class="form-input">
                <input type="text" id="tgUsername" placeholder="–Æ–∑–µ—Ä–Ω–µ–π–º –≤ Telegram (@username)" class="form-input">
                <button onclick="register()" class="btn btn-primary">–í–æ–π—Ç–∏ –≤ —á–∞—Ç</button>
            </div>
        </div>
    </div>
    
    <script>
        let inviteCode = '';
        
        async function checkCode() {
            const code = document.getElementById('inviteCode').value.trim();
            if (!code) {
                showError('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥');
                return;
            }
            
            const response = await fetch('/api/check-code', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code: code })
            });
            
            const data = await response.json();
            
            if (data.success) {
                inviteCode = code;
                document.getElementById('step1').style.display = 'none';
                document.getElementById('step2').style.display = 'block';
            } else {
                showError(data.message || '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥');
            }
        }
        
        async function register() {
            const nickname = document.getElementById('nickname').value.trim();
            const tgUsername = document.getElementById('tgUsername').value.trim();
            
            if (!nickname || !tgUsername) {
                showError('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }
            
            const response = await fetch('/api/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    nickname: nickname,
                    tgUsername: tgUsername.startsWith('@') ? tgUsername : '@' + tgUsername
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                localStorage.setItem('user', JSON.stringify(data.user));
                // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —á–∞—Ç
                window.location.href = 'chat.html';
            } else {
                showError(data.message);
            }
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => errorDiv.style.display = 'none', 3000);
        }
    </script>
</body>
</html>