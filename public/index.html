<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–∏–≤–∞—Ç–Ω—ã–π –ß–∞—Ç - –í—Ö–æ–¥</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="login-box" id="step1">
            <h1>üîí –ü—Ä–∏–≤–∞—Ç–Ω—ã–π –ß–∞—Ç</h1>
            <p>–î–ª—è –≤—Ö–æ–¥–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∏–Ω–≤–∞–π—Ç-–∫–æ–¥</p>
            
            <div class="form-group">
                <input type="text" id="inviteCode" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–Ω–≤–∞–π—Ç-–∫–æ–¥" class="form-input">
                <button onclick="checkCode()" class="btn btn-primary">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥</button>
            </div>
            
            <div id="error" class="error-message" style="display: none;"></div>
        </div>
        
        <div class="login-box" id="step2" style="display: none;">
            <h1>üìù –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è</h1>
            <p>–ö–æ–¥ –ø—Ä–∏–Ω—è—Ç! –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ:</p>
            
            <div class="form-group">
                <input type="text" id="nickname" placeholder="–ò–º—è –≤ —á–∞—Ç–µ" class="form-input">
                <input type="text" id="tgUsername" placeholder="@username –≤ Telegram" class="form-input">
                <button onclick="register()" class="btn btn-primary">–í–æ–π—Ç–∏ –≤ —á–∞—Ç</button>
            </div>
        </div>
    </div>
    
    <script>
        let currentCodeId = null;
        
        async function checkCode() {
            const codeInput = document.getElementById('inviteCode');
            const code = codeInput.value.trim();
            const errorDiv = document.getElementById('error');
            
            if (!code) {
                showError('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥');
                return;
            }
            
            try {
                const response = await fetch('/api/check-code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: code })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentCodeId = data.codeId;
                    document.getElementById('step1').style.display = 'none';
                    document.getElementById('step2').style.display = 'block';
                    errorDiv.style.display = 'none';
                } else {
                    showError(data.message || '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥');
                }
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
                console.error('–û—à–∏–±–∫–∞:', error);
            }
        }
        
        async function register() {
            const nickname = document.getElementById('nickname').value.trim();
            const tgUsername = document.getElementById('tgUsername').value.trim();
            const errorDiv = document.getElementById('error');
            
            if (!nickname) {
                showError('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –≤ —á–∞—Ç–µ');
                return;
            }
            
            if (!tgUsername) {
                showError('–í–≤–µ–¥–∏—Ç–µ Telegram username');
                return;
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º @ –µ—Å–ª–∏ –Ω–µ—Ç
            const formattedTgUsername = tgUsername.startsWith('@') ? tgUsername : '@' + tgUsername;
            
            try {
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        nickname: nickname,
                        tgUsername: formattedTgUsername,
                        codeId: currentCodeId
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    localStorage.setItem('chat_user', JSON.stringify(data.user));
                    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —á–∞—Ç
                    window.location.href = 'chat.html';
                } else {
                    showError(data.message || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
                }
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
                console.error('–û—à–∏–±–∫–∞:', error);
            }
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
        
        // –ù–∞–∂–∞—Ç–∏–µ Enter –≤ –ø–æ–ª–µ –∫–æ–¥–∞
        document.getElementById('inviteCode')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') checkCode();
        });
        
        // –ù–∞–∂–∞—Ç–∏–µ Enter –≤ –ø–æ–ª—è—Ö —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        document.getElementById('nickname')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') register();
        });
        
        document.getElementById('tgUsername')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') register();
        });
    </script>
</body>
</html>
